<!DOCTYPE html>

<html xmlns:th="http://www.thymeleaf.org">
<meta charset="UTF-8"/>
<head>
    <title>欢迎进入websocket测试工具</title>
    <script src="./js/jquery-3.1.1.js"></script>
    <script src="./js/sockjs.min.js"></script>
    <script src="./js/stomp.js"></script>

</head>
<body>
<p>
    sockJS+stomp版本测试工具
</p>


<div id="uriDiv">
    url：<input id="url" placeholder="webSocket的url" class="input"/>
    <br>
    subscribe：<input id="subscribe" placeholder="订阅接收消息的subscribe" class="input"/>
    <br>
    username：<input id="username" placeholder="客户端需要验证信息时，所需要的用户名" class="input"/>
    <br>
    password：<input id="password" placeholder="客户端需要验证信息时，所需要的密码" class="input"/>
    <br>
    <button id="connect" onclick="connect()">连接</button>
    <button id="disconnect" onclick="disconnect()">断开</button>
    <button id="clear" onclick="clear()">清空</button>
    <br>
</div>
<form id="chatForm">
    <textarea rows="4" cols="60" name="text" placeholder="发送消息内容"></textarea>
    <br>
    <input id="sendSubscribe" placeholder="发送消息的subscribe" class="input"/>
    <br>
    <input type="submit" value="发送"/>
</form>

<style type="text/css">
    .input {
        width: 500px;
        height: 30px;
        margin: 5px;
    }
</style>
<script>
    $('#chatForm').submit(function (e) {
        e.preventDefault();
        var text = $('#chatForm').find('textarea[name="text"]').val();
        sendSpittle(text);
        // $('#chatForm').clear();
    });

    var stompClient = null;
    var sock = null;

    function connect() {
        console.log("sdfsdf");
        //链接endpoint名称为 "url" 的endpoint。
        // sock = new SockJS($('#url').val());
        sock = new SockJS('http://localhost:9093/gs-guide-websocket');
        stompClient = Stomp.over(sock);
        // info带个人验证的
        // stomp.connect($('#username').val(), $('#password').val(), function (frame) {
        //     stomp.subscribe($('#subscribe').val(), handleNotification(frame));
        // })
        console.log("333");
        stompClient.connect({}, function connectCallback(frame) {
            console.log("sdfsdfsdf"+frame);
            // stompClient.subscribe($('#subscribe').val(), function (response) {
            stompClient.subscribe('/topic/subscribeTest', function (response) {
                handleNotification(response)
            });
        },function errorCallBack (error) {
            console.log("error"+error);
        });
    }

    function disconnect() {
        console.log("sdfsdf");
        if (stompClient != null) {
            stompClient.disconnect();
            console.log("连接断开")
        }

    }

    function clear() {
        $('#url').clean();
        $('#username').clean();
        $('#password').clean();
        $('#subscribe').clean();
    }


    function handleNotification(message) {
        $('#output').append("<b>Received: " + message.body + "</b><br/>")
    }

    function sendSpittle(text) {
        stompClient.send($('#sendSubscribe').val(), {}, JSON.stringify(text));
    }

    //订阅消息
    function subscribe1() {
        stompClient.subscribe('/topic/subscribeTest', function (response) {
            setMessageInnerHTML("已成功订阅/topic/subscribeTest");
            var returnData = JSON.parse(response.body);
            setMessageInnerHTML("/topic/subscribeTest 你接收到的消息为:" + returnData.responseMessage);
        });
    }

    //订阅消息
    function subscribe2() {
        stompClient.subscribe('/topic/sendTest', function (response) {
            setMessageInnerHTML("已成功订阅/topic/sendTest");
            var returnData = JSON.parse(response.body);
            setMessageInnerHTML("/topic/sendTest 你接收到的消息为:" + returnData.responseMessage);
        });
    }

    //将消息显示在网页上
    function setMessageInnerHTML(innerHTML) {
        document.getElementById('message').innerHTML += innerHTML + '<br/>';
    }

</script>

<div id="output"></div>
</body>
</html>