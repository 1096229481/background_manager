<!DOCTYPE html>

<html xmlns:th="http://www.thymeleaf.org">
<meta charset="UTF-8"/>
<head>
    <title>欢迎进入websocket测试工具</title>
    <script src="./js/jquery.js"></script>
    <script src="./js/sockjs.min.js"></script>
    <script src="./js/stomp.min.js"></script>
</head>
<body>
<p>
    sockJS+stomp版本测试工具
</p>

<form id="chatForm">
    <div id="uriDiv">
        url：<input id="url" placeholder="webSocket的url" class="input"/>
        <br>
        subscribe：<input id="subscribe" placeholder="订阅接收消息的subscribe" class="input"/>
        <br>
        username：<input id="username" placeholder="客户端需要验证信息时，所需要的用户名" class="input"/>
        <br>
        password：<input id="password" placeholder="客户端需要验证信息时，所需要的密码" class="input"/>
        <br>
        <button id="connect" onclick="connect">连接</button>
        <button id="disconnect" onclick="disconnect">断开</button>
        <button id="clear" onclick="clear">清空</button>
    </div>
    <br>
    <textarea rows="4" cols="60" name="text" placeholder="发送消息内容"></textarea>
    <br>
    <input id="sendSubscribe" placeholder="发送消息的subscribe" class="input"/>
    <br>
    <input type="submit" value="发送"/>

</form>

<style type="text/css">
    .input {
        width: 500px;
        height: 30px;
        margin: 5px;
    }
</style>
<script th:inline="javascript">
    $('#chatForm').submit(function (e) {
        e.preventDefault();
        var text = $('#chatForm').find('textarea[name="text"]').val();
        sendSpittle(text);
        $('#chatForm').clean();
    });

    var stomp = null;
    var sock = null;

    function connect() {
        //链接endpoint名称为 "url" 的endpoint。
        sock = new SockJS($('#url').val());
        stomp.over(sock);
        stomp.connect($('#username').val(), $('#password').val(), function (frame) {
            stomp.subscribe($('#subscribe').val(), handleNotification(frame));
        });
    }

    function disconnect() {
        if (stomp != null) {
            stomp.disconnect();
            console.log("连接断开")
        }

    }

    function clear() {
        $('#url').clean();
        $('#username').clean();
        $('#password').clean();
        $('#subscribe').clean();
    }


    function handleNotification(message) {
        $('#output').append("<b>Received: " + message.body + "</b><br/>")
    }

    function sendSpittle(text) {
        stomp.send($('sendSubscribe').val(), {}, JSON.stringify(text));
    }

</script>

<div id="output"></div>
</body>
</html>